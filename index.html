<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveBeats - Your Music, Your Vibe</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter & Roboto Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles & Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['var(--font-sans)', 'sans-serif'],
                        mono: ['var(--font-mono)', 'monospace'],
                    },
                    colors: {
                        'brand-bg': 'var(--color-bg)',
                        'brand-surface': 'var(--color-surface)',
                        'brand-elevated': 'var(--color-elevated)',
                        'brand-accent': 'var(--color-accent)',
                        'brand-accent-secondary': 'var(--color-accent-secondary)',
                        'brand-text-primary': 'var(--color-text-primary)',
                        'brand-text-secondary': 'var(--color-text-secondary)',
                    },
                    boxShadow: {
                        'neon': '0 0 15px var(--color-accent-shadow), 0 0 5px var(--color-accent-shadow-light)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --font-sans: 'Inter';
            --font-mono: 'Roboto Mono';
        }

        .theme-green {
            --color-bg: #121212;
            --color-surface: #181818;
            --color-elevated: #282828;
            --color-accent: #1DB954;
            --color-accent-secondary: #1ED760;
            --color-text-primary: #FFFFFF;
            --color-text-secondary: #B3B3B3;
            --color-accent-shadow: rgba(29, 185, 84, 0.5);
            --color-accent-shadow-light: rgba(29, 185, 84, 0.3);
        }

        .theme-blue-purple {
            --color-bg: #121212;
            --color-surface: #181818;
            --color-elevated: #242424;
            --color-accent: #3b82f6;
            --color-accent-secondary: #8b5cf6;
            --color-text-primary: #ffffff;
            --color-text-secondary: #b3b3b3;
            --color-accent-shadow: rgba(59, 130, 246, 0.5);
            --color-accent-shadow-light: rgba(59, 130, 246, 0.3);
        }
        
        .theme-light {
            --color-bg: #F9FAFB;
            --color-surface: #FFFFFF;
            --color-elevated: #E5E7EB;
            --color-accent: #1DB954;
            --color-accent-secondary: #10B981;
            --color-text-primary: #1F2937;
            --color-text-secondary: #6B7280;
            --color-accent-shadow: rgba(29, 185, 84, 0.3);
            --color-accent-shadow-light: rgba(29, 185, 84, 0.2);
        }
        
        .font-inter { --font-sans: 'Inter'; }
        .font-roboto-mono { --font-sans: 'Roboto Mono'; }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-surface); }
        ::-webkit-scrollbar-thumb { background: #404040; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #535353; }
        
        /* Custom Progress Bar Styles */
        input[type=range].custom-progress {
            -webkit-appearance: none;
            width: 100%;
            height: 2px;
            background: #404040;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        input[type=range].custom-progress:hover {
            opacity: 1;
        }

        input[type=range].custom-progress::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 4px;
            height: 20px;
            background: var(--color-accent);
            cursor: pointer;
            border-radius: 2px;
        }

        input[type=range].custom-progress::-moz-range-thumb {
            width: 4px;
            height: 20px;
            background: var(--color-accent);
            cursor: pointer;
            border-radius: 2px;
        }

        html, body { height: 100%; }
        .context-menu { position: absolute; z-index: 1000; }
        #current-album-art {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-brand-bg text-brand-text-primary font-sans antialiased">
    
    <audio id="audio-player"></audio>

    <!-- Login/Signup Screen -->
    <div id="auth-screen" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-brand-surface rounded-lg shadow-lg">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center">Login to WaveBeats</h2>
                <form id="login-form" class="mt-8 space-y-6">
                    <input id="loginEmail" type="email" placeholder="Email" class="w-full px-4 py-2 text-white bg-brand-elevated rounded-md focus:outline-none focus:ring-2 focus:ring-brand-accent" required>
                    <div class="relative">
                        <input id="loginPassword" type="password" placeholder="Password" class="w-full px-4 py-2 text-white bg-brand-elevated rounded-md focus:outline-none focus:ring-2 focus:ring-brand-accent" required>
                        <button type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-brand-text-secondary" id="toggleLoginPassword">
                            <svg id="login-eye-open" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <svg id="login-eye-closed" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.586-5.416 6.834-6.166M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.584 14.584A4.978 4.978 0 0015 12a5 5 0 00-5-5 4.978 4.978 0 00-2.584 1.416m11.168 5.168A10.023 10.023 0 0112 19c-1.605 0-3.11-.383-4.416-1.084m.001 10.832L3 21m18-18l-3 3"></path></svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-sm">
                            <a href="#" id="forgot-password" class="font-medium text-brand-accent-secondary hover:underline">Forgot password?</a>
                        </div>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 bg-brand-accent text-white rounded-md hover:opacity-80">Login</button>
                </form>
                <p class="mt-4 text-center text-sm text-brand-text-secondary">
                    Don't have an account? <a href="#" id="show-signup" class="font-medium text-brand-accent-secondary hover:underline">Sign up</a>
                </p>
            </div>
            <div id="signup-view" class="hidden">
                <h2 class="text-2xl font-bold text-center">Sign Up for WaveBeats</h2>
                <form id="signup-form" class="mt-8 space-y-6">
                    <input id="signupUsername" type="text" placeholder="Username" class="w-full px-4 py-2 text-white bg-brand-elevated rounded-md focus:outline-none focus:ring-2 focus:ring-brand-accent" required>
                    <input id="signupEmail" type="email" placeholder="Email" class="w-full px-4 py-2 text-white bg-brand-elevated rounded-md focus:outline-none focus:ring-2 focus:ring-brand-accent" required>
                    <div class="relative">
                        <input id="signupPassword" type="password" placeholder="Password" class="w-full px-4 py-2 text-white bg-brand-elevated rounded-md focus:outline-none focus:ring-2 focus:ring-brand-accent" required>
                        <button type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-brand-text-secondary" id="toggleSignupPassword">
                            <svg id="signup-eye-open" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <svg id="signup-eye-closed" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.586-5.416 6.834-6.166M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.584 14.584A4.978 4.978 0 0015 12a5 5 0 00-5-5 4.978 4.978 0 00-2.584 1.416m11.168 5.168A10.023 10.023 0 0112 19c-1.605 0-3.11-.383-4.416-1.084m.001 10.832L3 21m18-18l-3 3"></path></svg>
                        </button>
                    </div>
                    <button type="submit" class="w-full py-2 px-4 bg-brand-accent text-white rounded-md hover:opacity-80">Sign Up</button>
                </form>
                <p class="mt-4 text-center text-sm text-brand-text-secondary">
                    Already have an account? <a href="#" id="show-login" class="font-medium text-brand-accent-secondary hover:underline">Log in</a>
                </p>
            </div>
        </div>
    </div>

    <div id="player-screen" class="flex h-screen overflow-hidden hidden">
        <!-- Overlay for mobile menu -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-black p-6 flex flex-col flex-shrink-0 fixed md:relative h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-30">
            <div id="sidebar-header" class="text-2xl font-bold text-white flex items-center cursor-pointer flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-brand-accent" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 12.586l3.707-3.707a1 1 0 1 0-1.414-1.414L12 10.758l-3.293-3.293a1 1 0 0 0-1.414 1.414L10.586 12l-3.293 3.293a1 1 0 0 0 1.414 1.414L12 13.414l3.293 3.293a1 1 0 0 0 1.414-1.414L13.414 12l.293-.293z"></path></svg>
                WaveBeats
            </div>
            <nav id="sidebar-nav" class="mt-8 flex-shrink-0">
                <ul class="space-y-4">
                    <li><a href="#" data-view="home" class="nav-link flex items-center p-2 text-brand-text-primary bg-brand-elevated rounded-lg shadow-neon transition-all duration-300">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1V10a1 1 0 00-1-1H7a1 1 0 00-1 1v10a1 1 0 001 1h2z"></path></svg>
                        Home
                    </a></li>
                    <li><a href="#" data-view="library" class="nav-link flex items-center p-2 text-brand-text-secondary hover:bg-brand-elevated hover:text-white rounded-lg transition-all duration-300">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        Library
                    </a></li>
                     <li><a href="#" data-view="playlist" data-id="favorites" class="nav-link flex items-center p-2 text-brand-text-secondary hover:bg-brand-elevated hover:text-white rounded-lg transition-all duration-300">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        Favorites
                    </a></li>
                </ul>
            </nav>
            <div class="mt-8 pt-4 border-t border-brand-elevated flex-grow overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-brand-text-secondary font-semibold">Playlists</h3>
                    <button id="create-playlist-btn" class="text-brand-text-secondary hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </button>
                </div>
                <ul id="user-playlists-container" class="space-y-2">
                    <!-- User-created playlists will be injected here -->
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-brand-bg overflow-hidden">
            <!-- Top Bar -->
            <header class="flex items-center justify-between p-4 bg-brand-bg/80 backdrop-blur-sm flex-shrink-0 z-10">
                <button id="menu-toggle" class="md:hidden text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <div class="hidden md:block"></div>
                <div class="flex items-center gap-4 ml-auto">
                    <div class="relative w-full max-w-xs">
                        <input id="search-input" type="search" placeholder="Search..." class="w-full bg-brand-elevated text-white placeholder-brand-text-secondary rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-brand-accent transition-all">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <svg class="w-5 h-5 text-brand-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="profile-btn" class="w-10 h-10 rounded-full bg-brand-elevated flex items-center justify-center text-white hover:bg-brand-surface">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </button>
                        <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-brand-elevated rounded-md shadow-lg py-1 z-20 hidden">
                            <a href="#" id="profile-link" class="block px-4 py-2 text-sm text-brand-text-primary hover:bg-brand-surface">Profile</a>
                            <a href="#" id="settings-link" class="block px-4 py-2 text-sm text-brand-text-primary hover:bg-brand-surface">Settings</a>
                            <a href="#" id="upload-song-link" class="block px-4 py-2 text-sm text-brand-text-primary hover:bg-brand-surface">Upload Song</a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-brand-text-primary hover:bg-brand-surface">Log Out</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Player & Playlist -->
            <div class="flex-1 flex flex-col lg:flex-row p-2 md:p-4 gap-4 lg:gap-6 overflow-y-auto">
                <!-- Player Section -->
                <div class="w-full lg:w-1/3 flex-shrink-0 flex flex-col items-center bg-brand-surface rounded-xl p-4 md:p-6 shadow-lg">
                    <h2 class="text-lg font-semibold text-brand-text-secondary mb-4">Now Playing</h2>
                    <img id="current-album-art" src="https://placehold.co/400x400/121212/FFFFFF?text=WaveBeats" onerror="this.onerror=null;this.src='https://placehold.co/400x400/121212/FFFFFF?text=Error';" alt="Album Art" class="w-full max-w-[280px] md:max-w-[300px] aspect-square rounded-lg shadow-2xl shadow-black mb-6 cursor-grab active:cursor-grabbing">
                    <div class="text-center mb-6">
                        <h3 id="current-song-title" class="text-xl md:text-2xl font-bold text-white truncate">Select a Song</h3>
                        <p id="current-artist-name" class="text-md text-brand-text-secondary">Artist</p>
                    </div>
                    <div class="w-full mb-4">
                        <div class="relative pt-1">
                            <input id="progress-bar" type="range" min="0" max="100" value="0" class="custom-progress">
                            <div id="progress-fill" class="absolute top-1/2 left-0 h-0.5 bg-brand-accent -translate-y-1/2" style="width: 0%;"></div>
                        </div>
                        <div class="flex justify-between text-xs text-brand-text-secondary mt-1">
                            <span id="current-time">0:00</span>
                            <span id="total-duration">0:00</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-center w-full space-x-4 md:space-x-6 mb-4">
                        <button id="shuffle-btn" class="text-brand-text-secondary hover:text-white transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 3a1 1 0 01.894.553l2.832 5.664a1 1 0 010 .886l-2.832 5.664A1 1 0 0110 17v-2.121l-2.121-2.121a1 1 0 010-1.414L10 9.243V7.121L7.879 5H10V3zM5 4a1 1 0 011-1h2.121l2.121 2.121v2.122L8.12 10l2.122 2.121v2.121L8.121 16.364H6a1 1 0 01-1-1V4z"/></svg></button>
                        <button id="prev-btn" class="text-white hover:scale-105 transition-transform"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.95 9.707a1 1 0 010-1.414l6-6a1 1 0 111.414 1.414L7.071 9H15a1 1 0 110 2H7.071l4.293 4.293a1 1 0 11-1.414 1.414l-6-6z" clip-rule="evenodd"></path></svg></button>
                        <button id="play-pause-btn" class="w-16 h-16 flex items-center justify-center bg-gradient-to-br from-brand-accent-secondary to-brand-accent rounded-full text-white shadow-lg shadow-brand-accent-secondary/30 hover:shadow-neon transition-all duration-300 transform hover:scale-110">
                            <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button id="next-btn" class="text-white hover:scale-105 transition-transform"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M15.05 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L12.929 11H5a1 1 0 110-2h7.929l-4.293-4.293a1 1 0 011.414-1.414l6 6z" clip-rule="evenodd"></path></svg></button>
                        <button id="sleep-timer-btn" class="text-brand-text-secondary hover:text-white transition-colors">
                            <svg id="timer-off-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <svg id="timer-on-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-center w-full max-w-xs mt-2">
                        <div id="timer-display" class="text-sm text-brand-text-secondary">Sleep Timer: Off</div>
                    </div>
                </div>

                <!-- Playlist Section -->
                <div class="flex-1 bg-brand-surface rounded-xl p-4 shadow-lg flex flex-col">
                    <h2 id="playlist-title" class="text-lg font-semibold text-brand-text-secondary mb-4 px-2">Up Next</h2>
                    <div id="playlist" class="overflow-y-auto space-y-2 pr-2">
                        <!-- Playlist items will be injected here by JavaScript -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals & Context Menus -->
    <div id="create-playlist-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-brand-surface p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Create New Playlist</h2>
            <input id="new-playlist-name" type="text" placeholder="Playlist Name" class="w-full bg-brand-elevated text-white placeholder-brand-text-secondary rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-brand-accent-blue">
            <div class="flex justify-end space-x-4">
                <button id="cancel-create-playlist" class="py-2 px-4 rounded-lg text-white hover:bg-brand-elevated">Cancel</button>
                <button id="confirm-create-playlist" class="py-2 px-4 rounded-lg bg-brand-accent text-white hover:opacity-80">Create</button>
            </div>
        </div>
    </div>
    <div id="rename-playlist-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-brand-surface p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Rename Playlist</h2>
            <input id="rename-playlist-name" type="text" class="w-full bg-brand-elevated text-white placeholder-brand-text-secondary rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-brand-accent-blue">
            <div class="flex justify-end space-x-4">
                <button id="cancel-rename-playlist" class="py-2 px-4 rounded-lg text-white hover:bg-brand-elevated">Cancel</button>
                <button id="confirm-rename-playlist" class="py-2 px-4 rounded-lg bg-brand-accent text-white hover:opacity-80">Rename</button>
            </div>
        </div>
    </div>
    <div id="song-context-menu" class="context-menu hidden"><div id="song-context-menu-content" class="bg-brand-elevated rounded-lg shadow-lg py-2 w-48"></div></div>
    <div id="playlist-context-menu" class="context-menu hidden"><div id="playlist-context-menu-content" class="bg-brand-elevated rounded-lg shadow-lg py-2 w-48"></div></div>
    <div id="toast" class="fixed bottom-24 right-1/2 translate-x-1/2 bg-brand-accent-secondary text-white py-2 px-6 rounded-full shadow-lg opacity-0 transition-opacity duration-300"></div>
    <div id="shuffle-popup" class="fixed bg-brand-elevated text-white py-1 px-3 rounded-md shadow-lg opacity-0 transition-all duration-300 pointer-events-none z-50"></div>
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-brand-surface p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Profile</h2>
            <p class="text-brand-text-secondary">Email: <span id="user-email" class="text-white"></span></p>
            <div class="flex justify-end mt-6">
                <button id="close-profile-modal" class="py-2 px-4 rounded-lg text-white hover:bg-brand-elevated">Close</button>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-brand-surface p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-bold mb-6">Settings</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold mb-2">Color Theme</h3>
                    <div class="flex gap-4">
                        <button data-theme="theme-green" class="theme-btn h-10 w-10 rounded-full bg-[#1DB954] border-2 border-transparent"></button>
                        <button data-theme="theme-blue-purple" class="theme-btn h-10 w-10 rounded-full bg-[#3b82f6]" style="background-image: linear-gradient(to right, #3b82f6, #8b5cf6);"></button>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">Mode</h3>
                    <div class="flex flex-col gap-2">
                         <label class="flex items-center">
                            <input type="radio" name="mode" value="theme-green" class="form-radio text-brand-accent">
                            <span class="ml-2">Dark</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="mode" value="theme-light" class="form-radio text-brand-accent">
                            <span class="ml-2">Light</span>
                        </label>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">Font</h3>
                    <div class="flex flex-col gap-2">
                        <label class="flex items-center">
                            <input type="radio" name="font" value="font-inter" class="form-radio text-brand-accent">
                            <span class="ml-2">Inter (Default)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="font" value="font-roboto-mono" class="form-radio text-brand-accent">
                            <span class="ml-2 font-mono">Roboto Mono</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-8">
                <button id="close-settings-modal" class="py-2 px-4 rounded-lg text-white hover:bg-brand-elevated">Close</button>
            </div>
        </div>
    </div>
    <div id="upload-song-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-brand-surface p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Upload Song</h2>
            <form id="upload-song-form" class="space-y-4">
                <input id="upload-song-title" type="text" placeholder="Song Title" class="w-full bg-brand-elevated text-white p-3 rounded-md" required>
                <input id="upload-song-artist" type="text" placeholder="Artist Name" class="w-full bg-brand-elevated text-white p-3 rounded-md" required>
                <input id="upload-song-file" type="file" accept="audio/*" class="w-full text-white" required>
                <div id="upload-progress" class="w-full bg-brand-elevated rounded-full h-2.5 hidden">
                    <div class="bg-brand-accent h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-upload-song" class="py-2 px-4 rounded-lg text-white hover:bg-brand-elevated">Cancel</button>
                    <button type="submit" class="py-2 px-4 rounded-lg bg-brand-accent text-white hover:opacity-80">Upload</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBg3bCvRCeiX6PIVxm9qvlIxSgNXoMrly4",
            authDomain: "riverse-81d92.firebaseapp.com",
            projectId: "riverse-81d92",
            storageBucket: "riverse-81d92.appspot.com",
            messagingSenderId: "65192353405",
            appId: "1:65192353405:web:3c3b43693f909e7868db14",
            measurementId: "G-D2V5JNEX5X"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // All app logic is now inside the DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', () => {
            // Existing DOM Elements...
            const authScreen = document.getElementById('auth-screen');
            const playerScreen = document.getElementById('player-screen');
            const loginView = document.getElementById('login-view');
            const signupView = document.getElementById('signup-view');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const showSignup = document.getElementById('show-signup');
            const showLogin = document.getElementById('show-login');
            const logoutBtn = document.getElementById('logout-btn');
            const forgotPasswordLink = document.getElementById('forgot-password');
            const toggleLoginPassword = document.getElementById('toggleLoginPassword');
            const toggleSignupPassword = document.getElementById('toggleSignupPassword');
            const profileModal = document.getElementById('profile-modal');
            const profileLink = document.getElementById('profile-link');
            const closeProfileModalBtn = document.getElementById('close-profile-modal');
            const userEmailEl = document.getElementById('user-email');
            const settingsModal = document.getElementById('settings-modal');
            const settingsLink = document.getElementById('settings-link');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal');
            const uploadSongModal = document.getElementById('upload-song-modal');
            const uploadSongLink = document.getElementById('upload-song-link');
            const cancelUploadSongBtn = document.getElementById('cancel-upload-song');
            const uploadSongForm = document.getElementById('upload-song-form');
            const uploadProgress = document.getElementById('upload-progress');

            // UI Management
            const showPlayer = () => {
                authScreen.classList.add('hidden');
                playerScreen.classList.remove('hidden');
            };
            
            const showAuth = () => {
                playerScreen.classList.add('hidden');
                authScreen.classList.remove('hidden');
                if(audioPlayer.src) audioPlayer.pause();
            };

            // Authentication State Observer
            onAuthStateChanged(auth, user => {
                if (user) {
                    // User is signed in
                    userEmailEl.textContent = user.email;
                    showPlayer();
                } else {
                    // User is signed out
                    showAuth();
                }
            });

            // Signup Form
            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                
                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        // Signed in 
                        showToast('Account created successfully!');
                        // onAuthStateChanged will handle showing the player
                    })
                    .catch((error) => {
                        showToast(`Error: ${error.message}`);
                    });
            });

            // Login Form
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        // Signed in
                        // onAuthStateChanged will handle showing the player
                    })
                    .catch((error) => {
                        showToast(`Error: ${error.message}`);
                    });
            });

            // Logout Button
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth).catch((error) => {
                    showToast(`Logout Error: ${error.message}`);
                });
            });
            
            // Forgot Password
            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                const email = prompt("Please enter your email to reset your password:");
                if (email) {
                    sendPasswordResetEmail(auth, email)
                        .then(() => {
                            showToast("Password reset email sent!");
                        })
                        .catch((error) => {
                            showToast(`Error: ${error.message}`);
                        });
                }
            });

            // Switch between Login and Signup forms
            showSignup.addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); signupView.classList.remove('hidden'); });
            showLogin.addEventListener('click', (e) => { e.preventDefault(); signupView.classList.add('hidden'); loginView.classList.remove('hidden'); });
            
            // Password Visibility Toggles
            toggleLoginPassword.addEventListener('click', () => {
                const passwordInput = document.getElementById('loginPassword');
                const eyeOpen = document.getElementById('login-eye-open');
                const eyeClosed = document.getElementById('login-eye-closed');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                }
            });
            
            toggleSignupPassword.addEventListener('click', () => {
                const passwordInput = document.getElementById('signupPassword');
                const eyeOpen = document.getElementById('signup-eye-open');
                const eyeClosed = document.getElementById('signup-eye-closed');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                }
            });

            // Profile Modal
            profileLink.addEventListener('click', (e) => {
                e.preventDefault();
                profileModal.classList.remove('hidden');
                profileDropdown.classList.add('hidden');
            });
            closeProfileModalBtn.addEventListener('click', () => {
                profileModal.classList.add('hidden');
            });
            
            // Settings Modal
            settingsLink.addEventListener('click', (e) => {
                e.preventDefault();
                settingsModal.classList.remove('hidden');
                profileDropdown.classList.add('hidden');
            });
            closeSettingsModalBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            // Upload Song Modal
            uploadSongLink.addEventListener('click', (e) => {
                e.preventDefault();
                uploadSongModal.classList.remove('hidden');
                profileDropdown.classList.add('hidden');
            });
            cancelUploadSongBtn.addEventListener('click', () => {
                uploadSongModal.classList.add('hidden');
            });
            
            uploadSongForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const title = document.getElementById('upload-song-title').value;
                const artist = document.getElementById('upload-song-artist').value;
                const file = document.getElementById('upload-song-file').files[0];

                if (!file) {
                    showToast("Please select a file to upload.");
                    return;
                }

                const storageRef = ref(storage, `songs/${auth.currentUser.uid}/${file.name}`);
                const uploadTask = uploadBytesResumable(storageRef, file);

                uploadProgress.classList.remove('hidden');

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadProgress.querySelector('div').style.width = progress + '%';
                    }, 
                    (error) => {
                        showToast(`Upload failed: ${error.message}`);
                        uploadProgress.classList.add('hidden');
                    }, 
                    () => {
                        getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                            const newSong = {
                                id: Date.now(),
                                title: title,
                                artist: artist,
                                art: 'https://placehold.co/100x100/181818/FFFFFF?text=New',
                                url: downloadURL
                            };
                            allSongs.push(newSong);
                            renderPlaylist();
                            showToast('Song uploaded successfully!');
                            uploadSongModal.classList.add('hidden');
                            uploadSongForm.reset();
                            uploadProgress.classList.add('hidden');
                        });
                    }
                );
            });
            
            // Theme and Font Selection
            const themeButtons = document.querySelectorAll('.theme-btn');
            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const theme = button.dataset.theme;
                    document.body.className = document.body.className.replace(/theme-\w+/g, '');
                    document.body.classList.add(theme);
                    localStorage.setItem('wavebeats-theme', theme);
                    updateThemeSelection();
                });
            });

            const fontRadios = document.querySelectorAll('input[name="font"]');
            fontRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const font = radio.value;
                    document.body.className = document.body.className.replace(/font-\w+/g, '');
                    document.body.classList.add(font);
                    localStorage.setItem('wavebeats-font', font);
                });
            });
            
            const modeRadios = document.querySelectorAll('input[name="mode"]');
            modeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const theme = radio.value;
                    document.body.className = document.body.className.replace(/theme-\w+/g, '');
                    document.body.classList.add(theme);
                    localStorage.setItem('wavebeats-theme', theme);
                    updateThemeSelection();
                });
            });

            function updateThemeSelection() {
                const currentTheme = localStorage.getItem('wavebeats-theme') || 'theme-green';
                themeButtons.forEach(btn => {
                    if (btn.dataset.theme === currentTheme) {
                        btn.classList.add('ring-2', 'ring-white');
                    } else {
                        btn.classList.remove('ring-2', 'ring-white');
                    }
                });
                document.querySelector(`input[name="mode"][value="${currentTheme}"]`).checked = true;
            }

            function applyPreferences() {
                const theme = localStorage.getItem('wavebeats-theme') || 'theme-green';
                const font = localStorage.getItem('wavebeats-font') || 'font-inter';
                document.body.classList.add(theme, font);
                document.querySelector(`input[name="font"][value="${font}"]`).checked = true;
                updateThemeSelection();
            }

            applyPreferences();


            // The rest of your existing player code...
            const allSongs = [
                { id: 1, title: 'Cheques-Song', artist: 'Shubh', art: 'https://placehold.co/100x100/c026d3/FFFFFF?text=BL', url: 'assets/Cheques-Song.mp3' },
                { id: 2, title: 'Dope-Shope', artist: 'Yo-Yo H.Singh', art: 'https://placehold.co/100x100/4f46e5/FFFFFF?text=SE', url: 'assets/Dope-Shope.mp3' },
                { id: 3, title: '-Bandana', artist: 'Shubh', art: 'https://placehold.co/100x100/0284c7/FFFFFF?text=CP', url: 'assets/Shubh-Supreme.mp3' },
                { id: 4, title: 'Wavy--', artist: 'Karan-Aujla', art: 'https://placehold.co/100x100/10b981/FFFFFF?text=OD', url: 'assets/Wavy.mp3' },
                { id: 5, title: 'Charuke', artist: '-Vilen', art: 'https://placehold.co/100x100/f59e0b/FFFFFF?text=MC', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.43_fd27ee08.mp3' },
                { id: 6, title: 'Tu Jane Na', artist: 'Atif-Aslam', art: 'https://placehold.co/100x100/ef4444/FFFFFF?text=NR', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.44_c70cc584.mp3' },
                { id: 7, title: 'Hass-Hass', artist: 'Diljit Dosanjh', art: 'https://placehold.co/100x100/6d28d9/FFFFFF?text=FF', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.44_d1c7f616.mp3' },
                { id: 8, title: 'Supreme', artist: 'Shubh', art: 'https://placehold.co/100x100/db2777/FFFFFF?text=LJ', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.45_78ad8270.mp3' },
                { id: 9, title: 'Jo-Tum', artist: 'Anuv-Jain', art: 'https://placehold.co/100x100/1e3a8a/FFFFFF?text=SS', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.45_49333088.mp3' },
                { id: 10, title: 'Haye-Mera-dil', artist: 'Yo-Yo H.Singh', art: 'https://placehold.co/100x100/312e81/FFFFFF?text=AD', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.45_c062ad97.mp3' },
                 { id: 6, title: 'With-You', artist: 'AP-Dillon', art: 'https://placehold.co/100x100/ef4444/FFFFFF?text=NR', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.46_3c56a4a0.mp3' },
                { id: 7, title: 'Mast-Magan', artist: 'Arjit-Singh', art: 'https://placehold.co/100x100/6d28d9/FFFFFF?text=FF', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.46_091ff547.mp3' },
                { id: 8, title: 'Kalank-Song', artist: 'Arjit-Singh', art: 'https://placehold.co/100x100/db2777/FFFFFF?text=LJ', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.46_c36e1aaf.mp3' },
                { id: 9, title: 'Dhun', artist: 'Arjit-Singh', art: 'https://placehold.co/100x100/1e3a8a/FFFFFF?text=SS', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.47_2b50e659.mp3' },
                { id: 10, title: 'Lalkaara-', artist: 'Diljit-Dosanjh', art: 'https://placehold.co/100x100/312e81/FFFFFF?text=AD', url: 'assets/WhatsApp Audio 2025-08-15 at 17.35.47_82604933.mp3' },
            ];

            // DOM Elements
            const audioPlayer = document.getElementById('audio-player');
            const playlistElement = document.getElementById('playlist');
            const currentAlbumArt = document.getElementById('current-album-art');
            const currentSongTitle = document.getElementById('current-song-title');
            const currentArtistName = document.getElementById('current-artist-name');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarHeader = document.getElementById('sidebar-header');
            const sleepTimerBtn = document.getElementById('sleep-timer-btn');
            const timerDisplay = document.getElementById('timer-display');
            const timerOnIcon = document.getElementById('timer-on-icon');
            const timerOffIcon = document.getElementById('timer-off-icon');
            const searchInput = document.getElementById('search-input');
            const userPlaylistsContainer = document.getElementById('user-playlists-container');
            const createPlaylistBtn = document.getElementById('create-playlist-btn');
            const createPlaylistModal = document.getElementById('create-playlist-modal');
            const cancelCreatePlaylistBtn = document.getElementById('cancel-create-playlist');
            const confirmCreatePlaylistBtn = document.getElementById('confirm-create-playlist');
            const newPlaylistNameInput = document.getElementById('new-playlist-name');
            const renamePlaylistModal = document.getElementById('rename-playlist-modal');
            const cancelRenamePlaylistBtn = document.getElementById('cancel-rename-playlist');
            const confirmRenamePlaylistBtn = document.getElementById('confirm-rename-playlist');
            const renamePlaylistNameInput = document.getElementById('rename-playlist-name');
            const playlistTitleElement = document.getElementById('playlist-title');
            const songContextMenu = document.getElementById('song-context-menu');
            const songContextMenuContent = document.getElementById('song-context-menu-content');
            const playlistContextMenu = document.getElementById('playlist-context-menu');
            const playlistContextMenuContent = document.getElementById('playlist-context-menu-content');
            const toast = document.getElementById('toast');
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            const currentTimeEl = document.getElementById('current-time');
            const totalDurationEl = document.getElementById('total-duration');
            const shuffleBtn = document.getElementById('shuffle-btn');
            const shufflePopup = document.getElementById('shuffle-popup');
            const profileBtn = document.getElementById('profile-btn');
            const profileDropdown = document.getElementById('profile-dropdown');

            // State
            let currentSongId = null;
            let sleepTimerInterval = null;
            let sleepTimerClickCount = 0;
            const timerDurations = [15, 30, 45, 60, 0]; // In minutes
            let userPlaylists = [
                { id: 'favorites', name: 'Favorites', songs: [1, 5, 8] },
                { id: 'chill', name: 'Chill Vibes', songs: [4, 9] }
            ];
            let currentView = { type: 'home', id: null };
            let playlistToRenameId = null;
            let touchStartX = 0;
            let touchEndX = 0;
            let isDragging = false;
            let isShuffle = false;

            function renderUserPlaylists() {
                userPlaylistsContainer.innerHTML = '';
                const editablePlaylists = userPlaylists.filter(p => p.id !== 'favorites');
                editablePlaylists.forEach(pl => {
                    const li = document.createElement('li');
                    li.className = 'group flex items-center justify-between';
                    li.innerHTML = `
                        <a href="#" data-view="playlist" data-id="${pl.id}" class="nav-link flex-grow p-2 text-brand-text-secondary hover:text-white rounded-lg transition-colors">${pl.name}</a>
                        <button class="playlist-options-btn text-brand-text-secondary hover:text-white opacity-0 group-hover:opacity-100 transition-opacity" data-playlist-id="${pl.id}">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        </button>`;
                    userPlaylistsContainer.appendChild(li);
                });
                document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', handleNavClick));
                document.querySelectorAll('.playlist-options-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showPlaylistContextMenu(e.currentTarget);
                }));
            }

            function renderPlaylist() {
                const searchTerm = searchInput.value.toLowerCase();
                let songsToRender = [];
                let title = 'Up Next';
                
                if (currentView.type === 'playlist') {
                    const playlist = userPlaylists.find(p => p.id === currentView.id);
                    if (playlist) {
                        songsToRender = playlist.songs.map(songId => allSongs.find(s => s.id === songId)).filter(Boolean);
                        title = playlist.name;
                    }
                } else if (currentView.type === 'library') {
                    songsToRender = [...allSongs];
                    title = 'My Library';
                } else {
                    songsToRender = [...allSongs];
                    title = 'Up Next';
                }
                
                playlistTitleElement.textContent = title;

                const filteredSongs = songsToRender.filter(song => 
                    song.title.toLowerCase().includes(searchTerm) || 
                    song.artist.toLowerCase().includes(searchTerm)
                );

                playlistElement.innerHTML = '';
                if (filteredSongs.length === 0) {
                    playlistElement.innerHTML = `<p class="text-brand-text-secondary text-center p-4">No songs found.</p>`;
                }

                filteredSongs.forEach(song => {
                    const isActive = song.id === currentSongId;
                    const itemClass = isActive ? 'bg-gradient-to-r from-brand-accent-secondary/30 to-brand-accent/30 shadow-neon' : 'hover:bg-brand-elevated';
                    const songElement = document.createElement('div');
                    songElement.className = `flex items-center p-3 rounded-lg cursor-pointer transition-all duration-300 group ${itemClass}`;
                    songElement.dataset.songId = song.id;
                    songElement.innerHTML = `
                        <img src="${song.art}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/181818/FFFFFF?text=Err';" alt="${song.title}" class="w-12 h-12 rounded-md mr-4">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-white truncate">${song.title}</p>
                            <p class="text-sm text-brand-text-secondary">${song.artist}</p>
                        </div>
                        <p class="text-sm text-brand-text-secondary ml-2 flex-shrink-0">${song.duration || ''}</p>
                        <button class="add-to-playlist-btn text-brand-text-secondary hover:text-white ml-4 opacity-0 group-hover:opacity-100 transition-opacity" data-song-id="${song.id}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        </button>`;
                    songElement.querySelector('.add-to-playlist-btn').addEventListener('click', (e) => { e.stopPropagation(); showSongContextMenu(e.target.closest('button')); });
                    songElement.addEventListener('click', (e) => { if (!e.target.closest('.add-to-playlist-btn')) { playSong(song.id); } });
                    playlistElement.appendChild(songElement);
                });
            }

            function playSong(songId) {
                const song = allSongs.find(s => s.id === songId);
                if (!song) return;
                currentSongId = songId;
                currentAlbumArt.src = song.art.replace('100x100', '400x400');
                currentSongTitle.textContent = song.title;
                currentArtistName.textContent = song.artist;
                audioPlayer.src = song.url;
                audioPlayer.play();
                renderPlaylist();
            }

            function togglePlayPause() {
                if(audioPlayer.paused) {
                    if (!currentSongId && allSongs.length > 0) playSong(allSongs[0].id);
                    else { audioPlayer.play(); }
                } else {
                    audioPlayer.pause();
                }
            }
            
            function updatePlayPauseIcon() {
                if(audioPlayer.paused) {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                } else {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                }
            }

            function playNext() {
                const currentList = (currentView.type === 'playlist' ? userPlaylists.find(p => p.id === currentView.id)?.songs.map(id => allSongs.find(s => s.id === id)) : allSongs) || allSongs;
                if (currentList.length === 0) return;

                if (isShuffle) {
                    playRandom(currentList);
                    return;
                }

                const currentIndex = currentList.findIndex(song => song?.id === currentSongId);
                const nextIndex = currentIndex === -1 ? 0 : (currentIndex + 1) % currentList.length;
                if(currentList[nextIndex]) playSong(currentList[nextIndex].id);
            }

            function playPrev() {
                const currentList = (currentView.type === 'playlist' ? userPlaylists.find(p => p.id === currentView.id)?.songs.map(id => allSongs.find(s => s.id === id)) : allSongs) || allSongs;
                if (currentList.length === 0) return;

                if (isShuffle) {
                    playRandom(currentList);
                    return;
                }

                const currentIndex = currentList.findIndex(song => song?.id === currentSongId);
                const prevIndex = currentIndex <= 0 ? currentList.length - 1 : currentIndex - 1;
                if(currentList[prevIndex]) playSong(currentList[prevIndex].id);
            }
            
            function playRandom(currentList) {
                if (currentList.length <= 1) return;
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * currentList.length);
                } while (currentList[randomIndex].id === currentSongId);
                playSong(currentList[randomIndex].id);
            }

            function toggleShuffle() {
                isShuffle = !isShuffle;
                shuffleBtn.classList.toggle('text-brand-accent', isShuffle);
                showShufflePopup(isShuffle ? 'Shuffle On' : 'Shuffle Off');
            }
            
            function showShufflePopup(message) {
                const btnRect = shuffleBtn.getBoundingClientRect();
                shufflePopup.textContent = message;
                shufflePopup.style.left = `${btnRect.left + btnRect.width / 2 - shufflePopup.offsetWidth / 2}px`;
                shufflePopup.style.top = `${btnRect.top - shufflePopup.offsetHeight - 8}px`; // 8px gap
                shufflePopup.classList.remove('opacity-0');
                setTimeout(() => {
                    shufflePopup.classList.add('opacity-0');
                }, 1500);
            }

            function openSidebar() { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); }
            function closeSidebar() { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); }

            function formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${String(secs).padStart(2, '0')}`;
            }
            
            function updateProgress() {
                const { duration, currentTime } = audioPlayer;
                const progressPercent = (currentTime / duration) * 100;
                progressBar.value = progressPercent;
                progressFill.style.width = `${progressPercent}%`;
                currentTimeEl.textContent = formatTime(currentTime);
            }

            function setProgress() {
                audioPlayer.currentTime = (progressBar.value / 100) * audioPlayer.duration;
            }

            function handleSleepTimer() {
                clearInterval(sleepTimerInterval);
                sleepTimerClickCount = (sleepTimerClickCount + 1) % timerDurations.length;
                const durationMinutes = timerDurations[sleepTimerClickCount];
                if (durationMinutes > 0) {
                    let remainingSeconds = durationMinutes * 60;
                    timerDisplay.textContent = `Sleep: ${formatTime(remainingSeconds)}`;
                    sleepTimerBtn.classList.add('text-brand-accent');
                    timerOffIcon.classList.add('hidden'); timerOnIcon.classList.remove('hidden');
                    sleepTimerInterval = setInterval(() => {
                        remainingSeconds--;
                        if (remainingSeconds < 0) {
                            clearInterval(sleepTimerInterval);
                            audioPlayer.pause();
                            handleSleepTimer(); // Cycle to off
                        } else {
                           timerDisplay.textContent = `Sleep: ${formatTime(remainingSeconds)}`;
                        }
                    }, 1000);
                } else {
                    timerDisplay.textContent = 'Sleep Timer: Off';
                    sleepTimerBtn.classList.remove('text-brand-accent');
                    timerOnIcon.classList.add('hidden'); timerOffIcon.classList.remove('hidden');
                }
            }

            function handleNavClick(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('text-brand-text-primary', 'bg-brand-elevated', 'shadow-neon');
                    link.classList.add('text-brand-text-secondary');
                });
                const currentTarget = e.currentTarget.closest('.nav-link') || e.currentTarget;
                currentTarget.classList.add('text-brand-text-primary', 'bg-brand-elevated', 'shadow-neon');
                currentTarget.classList.remove('text-brand-text-secondary');
                
                currentView.type = currentTarget.dataset.view;
                currentView.id = currentTarget.dataset.id || null;
                renderPlaylist();
                
                if (window.innerWidth < 768) {
                    closeSidebar();
                }
            }

            function showCreatePlaylistModal() { createPlaylistModal.classList.remove('hidden'); newPlaylistNameInput.focus(); }
            function hideCreatePlaylistModal() { createPlaylistModal.classList.add('hidden'); newPlaylistNameInput.value = ''; }
            
            function confirmCreatePlaylist() {
                const name = newPlaylistNameInput.value.trim();
                if (name) {
                    userPlaylists.push({ id: `playlist_${Date.now()}`, name: name, songs: [] });
                    renderUserPlaylists();
                    hideCreatePlaylistModal();
                }
            }

            function showRenamePlaylistModal(playlistId) {
                const playlist = userPlaylists.find(p => p.id === playlistId);
                if(playlist) {
                    playlistToRenameId = playlistId;
                    renamePlaylistNameInput.value = playlist.name;
                    renamePlaylistModal.classList.remove('hidden');
                    renamePlaylistNameInput.focus();
                }
            }
            function hideRenamePlaylistModal() { renamePlaylistModal.classList.add('hidden'); playlistToRenameId = null; }
            
            function confirmRenamePlaylist() {
                const newName = renamePlaylistNameInput.value.trim();
                if(newName && playlistToRenameId) {
                    const playlist = userPlaylists.find(p => p.id === playlistToRenameId);
                    if(playlist) {
                        playlist.name = newName;
                        renderUserPlaylists();
                        if(currentView.id === playlistToRenameId) {
                            renderPlaylist();
                        }
                    }
                }
                hideRenamePlaylistModal();
            }

            function deletePlaylist(playlistId) {
                userPlaylists = userPlaylists.filter(p => p.id !== playlistId);
                if(currentView.id === playlistId) {
                    document.querySelector('.nav-link[data-view="home"]').click();
                }
                renderUserPlaylists();
            }
            
            function showToast(message) {
                toast.textContent = message;
                toast.classList.remove('opacity-0');
                setTimeout(() => { toast.classList.add('opacity-0'); }, 2000);
            }

            function showSongContextMenu(button) {
                const songId = parseInt(button.dataset.songId);
                const rect = button.getBoundingClientRect();
                songContextMenu.style.left = `${rect.left - songContextMenu.offsetWidth + rect.width}px`;
                songContextMenu.style.top = `${rect.bottom + 8}px`;
                
                songContextMenuContent.innerHTML = '<div class="px-3 py-1 text-brand-text-secondary text-sm">Add to playlist...</div>';
                userPlaylists.forEach(pl => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'block px-4 py-2 text-sm text-white hover:bg-brand-surface';
                    item.textContent = pl.name;
                    item.onclick = (e) => {
                        e.preventDefault();
                        const playlist = userPlaylists.find(p => p.id === pl.id);
                        if (playlist && !playlist.songs.includes(songId)) {
                            playlist.songs.push(songId);
                            showToast(`Added to ${pl.name}`);
                            if(currentView.type === 'playlist' && currentView.id === pl.id) renderPlaylist();
                        } else {
                            showToast(`Already in ${pl.name}`);
                        }
                        hideSongContextMenu();
                    };
                    songContextMenuContent.appendChild(item);
                });
                songContextMenu.classList.remove('hidden');
            }
            function hideSongContextMenu() { songContextMenu.classList.add('hidden'); }

            function showPlaylistContextMenu(button) {
                const playlistId = button.dataset.playlistId;
                const rect = button.getBoundingClientRect();
                playlistContextMenu.style.left = `${rect.left - playlistContextMenu.offsetWidth + rect.width}px`;
                playlistContextMenu.style.top = `${rect.bottom + 8}px`;
                
                playlistContextMenuContent.innerHTML = '';
                const renameItem = document.createElement('a');
                renameItem.href = '#';
                renameItem.className = 'block px-4 py-2 text-sm text-white hover:bg-brand-surface';
                renameItem.textContent = 'Rename';
                renameItem.onclick = (e) => { e.preventDefault(); hidePlaylistContextMenu(); showRenamePlaylistModal(playlistId); };
                
                const deleteItem = document.createElement('a');
                deleteItem.href = '#';
                deleteItem.className = 'block px-4 py-2 text-sm text-red-500 hover:bg-brand-surface';
                deleteItem.textContent = 'Delete';
                deleteItem.onclick = (e) => { e.preventDefault(); hidePlaylistContextMenu(); deletePlaylist(playlistId); };

                playlistContextMenuContent.appendChild(renameItem);
                playlistContextMenuContent.appendChild(deleteItem);
                playlistContextMenu.classList.remove('hidden');
            }
            function hidePlaylistContextMenu() { playlistContextMenu.classList.add('hidden'); }

            function handleGesture(e) {
                if (isDragging) {
                    const currentX = e.type.includes('touch') ? e.changedTouches[0].clientX : e.clientX;
                    const diff = currentX - touchStartX;
                    currentAlbumArt.style.transform = `translateX(${diff}px) scale(0.95)`;
                    currentAlbumArt.style.opacity = 1 - Math.abs(diff / (currentAlbumArt.offsetWidth / 1.5));
                }
            }

            function handleGestureEnd(e) {
                if(isDragging) {
                    isDragging = false;
                    currentAlbumArt.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                    touchEndX = e.type.includes('touch') ? e.changedTouches[0].clientX : e.clientX;
                    const diff = touchEndX - touchStartX;
                    
                    if (Math.abs(diff) > 50) { // Swipe threshold
                        const direction = diff > 0 ? 1 : -1;
                        currentAlbumArt.style.transform = `translateX(${direction * 100}%) scale(0.9)`;
                        currentAlbumArt.style.opacity = 0;
                        
                        const transitionEndHandler = () => {
                            currentAlbumArt.removeEventListener('transitionend', transitionEndHandler);
                            if (direction > 0) playPrev(); else playNext();
                            
                            currentAlbumArt.style.transition = 'none';
                            currentAlbumArt.style.transform = `translateX(${-direction * 100}%)`;
                            currentAlbumArt.offsetHeight; // Force reflow
                            
                            requestAnimationFrame(() => {
                                currentAlbumArt.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                                currentAlbumArt.style.transform = 'translateX(0%) scale(1)';
                                currentAlbumArt.style.opacity = 1;
                            });
                        };
                        currentAlbumArt.addEventListener('transitionend', transitionEndHandler);

                    } else {
                         currentAlbumArt.style.transform = 'translateX(0px) scale(1)';
                         currentAlbumArt.style.opacity = 1;
                    }
                }
            }

            function handleGestureStart(e) {
                isDragging = true;
                touchStartX = e.type.includes('touch') ? e.changedTouches[0].clientX : e.clientX;
                currentAlbumArt.style.transition = 'none';
            }
            
            // Event Listeners
            playPauseBtn.addEventListener('click', togglePlayPause);
            nextBtn.addEventListener('click', playNext);
            prevBtn.addEventListener('click', playPrev);
            shuffleBtn.addEventListener('click', toggleShuffle);
            menuToggle.addEventListener('click', (e) => { e.stopPropagation(); if (sidebar.classList.contains('-translate-x-full')) openSidebar(); else closeSidebar(); });
            sidebarOverlay.addEventListener('click', closeSidebar);
            sidebarHeader.addEventListener('click', closeSidebar);
            sleepTimerBtn.addEventListener('click', handleSleepTimer);
            searchInput.addEventListener('input', renderPlaylist);
            createPlaylistBtn.addEventListener('click', showCreatePlaylistModal);
            cancelCreatePlaylistBtn.addEventListener('click', hideCreatePlaylistModal);
            confirmCreatePlaylistBtn.addEventListener('click', confirmCreatePlaylist);
            cancelRenamePlaylistBtn.addEventListener('click', hideRenamePlaylistModal);
            confirmRenamePlaylistBtn.addEventListener('click', confirmRenamePlaylist);
            
            // Audio Player Events
            audioPlayer.addEventListener('play', updatePlayPauseIcon);
            audioPlayer.addEventListener('pause', updatePlayPauseIcon);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', () => {
                totalDurationEl.textContent = formatTime(audioPlayer.duration);
            });
            progressBar.addEventListener('input', setProgress);

            // Swipe Gestures for Album Art
            currentAlbumArt.addEventListener('touchstart', handleGestureStart);
            document.addEventListener('touchmove', handleGesture);
            document.addEventListener('touchend', handleGestureEnd);

            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => { 
                if (!songContextMenu.contains(e.target) && !e.target.closest('.add-to-playlist-btn')) { hideSongContextMenu(); }
                if (!playlistContextMenu.contains(e.target) && !e.target.closest('.playlist-options-btn')) { hidePlaylistContextMenu(); }
                if (!profileDropdown.contains(e.target) && !e.target.closest('#profile-btn')) {
                    profileDropdown.classList.add('hidden');
                }
            });

            // Initial render
            renderUserPlaylists();
            renderPlaylist();
        });
    </script>

</body>
</html>
